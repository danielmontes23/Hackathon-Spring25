---
import Layout from '../layouts/Layout.astro';
import '../styles/Global.css';
import DynamicResumeSections from '../components/DynamicResumeSections.jsx';
---

<Layout>
  <main style="max-width: 700px; margin: 2rem auto;">
    <h1>Resume Builder</h1>
    <form id="resume-form">
      <section>
        <h2>Personal Info</h2>
        <label>
          First Name:
          <input type="text" name="first_name" id="first_name" required />
        </label>
        <label>
          Last Name:
          <input type="text" name="last_name" id="last_name" required />
        </label>
        <label>
          Email:
          <input type="email" name="email" id="email" required />
        </label>
        <label>
          Phone:
          <input
            type="tel"
            name="phone"
            id="phone"
            inputmode="tel"
            pattern="^\d{10,15}$"
            maxlength="15"
            title="Please enter a valid phone number (numbers only, 10-15 digits)"
          />
        </label>
      </section>

      <section id="social-links-section">
        <h2>Social Media Links</h2>
        <div id="social-links-list"></div>
        <button type="button" id="add-social-link">Add Social Link</button>
      </section>

      <DynamicResumeSections client:load />

      <button type="submit">Generate Resume</button>
    </form>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const phoneInput = document.getElementById('phone');
        if (phoneInput) {
          phoneInput.addEventListener('input', () => {
            phoneInput.value = phoneInput.value.replace(/\D/g, '');
          });
        }

        ['first_name', 'last_name', 'email', 'phone'].forEach(field => {
          const input = document.getElementById(field);
          if (input) {
            // Load from localStorage
            const saved = localStorage.getItem(field);
            if (saved) input.value = saved;
            // Save on change
            input.addEventListener('input', () => {
              localStorage.setItem(field, input.value);
            });
          }
        });

        // Persist DOB
        const dobInput = document.getElementById('dob');
        if (dobInput) {
          const saved = localStorage.getItem('dob');
          if (saved) dobInput.value = saved;
          dobInput.addEventListener('input', () => {
            localStorage.setItem('dob', dobInput.value);
          });
        }

        // Social Media Links logic
        const socialLinksList = document.getElementById('social-links-list');
        const addSocialBtn = document.getElementById('add-social-link');
        let socialLinks = JSON.parse(localStorage.getItem('socialLinks') || '[]');

        function renderSocialLinks() {
          socialLinksList.innerHTML = '';
          socialLinks.forEach((link, idx) => {
            const container = document.createElement('div');
            container.style.display = 'flex';
            container.style.alignItems = 'center';
            container.style.gap = '0.5rem';
            container.style.marginBottom = '0.7rem';

            const platformInput = document.createElement('input');
            platformInput.type = 'text';
            platformInput.placeholder = 'Platform (e.g. LinkedIn)';
            platformInput.value = link.platform || '';
            platformInput.required = false;
            platformInput.style.flex = '1';
            platformInput.addEventListener('input', e => {
              socialLinks[idx].platform = e.target.value;
              localStorage.setItem('socialLinks', JSON.stringify(socialLinks));
            });

            const urlInput = document.createElement('input');
            urlInput.type = 'url';
            urlInput.placeholder = 'Profile URL';
            urlInput.value = link.url || '';
            urlInput.required = false;
            urlInput.style.flex = '2';
            urlInput.addEventListener('input', e => {
              socialLinks[idx].url = e.target.value;
              localStorage.setItem('socialLinks', JSON.stringify(socialLinks));
            });

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.textContent = 'Delete';
            removeBtn.style.marginLeft = '0.5rem';
            removeBtn.addEventListener('click', () => {
              socialLinks.splice(idx, 1);
              localStorage.setItem('socialLinks', JSON.stringify(socialLinks));
              renderSocialLinks();
            });

            container.appendChild(platformInput);
            container.appendChild(urlInput);
            container.appendChild(removeBtn);

            socialLinksList.appendChild(container);
          });
        }

        addSocialBtn.addEventListener('click', () => {
          socialLinks.push({ platform: '', url: '' });
          localStorage.setItem('socialLinks', JSON.stringify(socialLinks));
          renderSocialLinks();
        });

        renderSocialLinks();
      });
    </script>
  </main>
</Layout>
